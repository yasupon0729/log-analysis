---

# ログ解析アプリ（S3直読み / DB・認証なし / ダーク・青基調）— 要件まとめ

## 🎯 ゴール

- 指定日（単日）を選択 → **S3のJSONログを取得** → **テーブル表示（フィルタ/ソート/検索）**
- **拡張性**を残しつつ、まずは**最短でローンチ**（グラフ不要・テーブル中心）

## 🧭 スコープ（MVP）

- 対象期間：**最新3日分**（UI：単日指定＋クイック「直近3日」）
- 表示：TanStack Table で**動的列**対応（Top-K頻出キーを自動列化、残りはJSONセルで展開）
- 非対象：認証、DB保持、アラート、集計チャート（将来拡張）

## 🧱 技術スタック

- **Runtime**: Bun 
- **Web**: Next.js v15（App Router） Typescript
- **UI**: Panda CSS（**ダーク固定・青基調**）
- **Table**: TanStack Table（仮想化・列切替・フィルタ）
- **Linter/Formatter**: Biome
- **環境**: WSL（ローカル開発）

## 📁 S3 構造（実データに合わせて最小運用）

- バケット：`gexel-secure-storage`
- 主プレフィックス：`/product`, `/backup`, `/logs`, `/2025-10`
- **MVP対象拡張子**：`.json`
- （提案）キー命名テンプレ
    
    `logs/<service>/<yyyy>/<mm>/<dd>/<service>-<yyyyMMdd>-<hh>.json`
    
    例：`logs/webapp/2025/10/02/webapp-20251002-14.json`
    

> 例外：app_20251002.log.gz.enc（復号 → 解凍 → .log 正規化が必要）
> 

### 🔐 復号・解凍例（OpenSSL想定）

```bash
# 復号（AES-256-CBCの例。鍵/IVは16進）
openssl enc -d -aes-256-cbc \
  -in app_20251002.log.gz.enc \
  -out app_20251002.log.gz \
  -K <hex_key> -iv <hex_iv>

# 解凍
gunzip app_20251002.log.gz

```

> 実際の暗号方式/鍵管理（KMS, Passphraseなど）に合わせて調整
> 

## 🔌 .env（最小）

```
S3_REGION=ap-northeast-1
S3_BUCKET=gexel-secure-storage
S3_PREFIX=logs/
AWS_ACCESS_KEY_ID=***
AWS_SECRET_ACCESS_KEY=***

```

## 🔒 IAM（最小権限）

- `s3:ListBucket`（prefix限定：`logs/`）
- `s3:GetObject`（`logs/`配下）

## 🧪 データ正規化（表示用）

- **標準キー**（存在すれば採用）：`ts`, `level`, `service`, `host`, `path`, `message`
- **動的列**：任意キーのうち**頻出Top-K**を自動列化、残りは`json`セルで展開
- **非JSON行（.log）**：初期は簡易パーサ（JSONライク行優先）—将来改善可能

## 🧰 API 構成（サーバ側でS3アクセス）

- `GET /api/logs?date=YYYY-MM-DD&service=*&level=*&q=*`
    - 処理：`ListObjectsV2` → `GetObject`（必要なら解凍）→ JSON正規化 → 軽いフィルタ → 配列返却
    - CORS回避のため**必ずサーバ側**でS3アクセス

## 📊 ユーザーダッシュボード（GeXel 拡張）

- ユーザー毎の解析履歴とアンケート結果を集約するダッシュボードを `/users` に配置。
- 解析結果は `product/user/<user-id>/analysis_result/...`（既存）を走査し、時系列やモデル利用状況を算出。
- アンケートは `product/user/<user-id>/questionnaire/gexel/answers.json` を S3 から取得し、回答日時と内容を表示。
- 新規 API：
  - `GET /api/users` – ユーザー一覧と最新解析情報・主要モデル・アンケート回答有無。
  - `GET /api/users/[id]/insights` – ユーザー詳細（解析サマリ、タイムライン、モデル利用集計、アンケート回答）。
- フロントは Panda CSS で 2 カラム構成。モデル利用状況はトップ5件をバッジ表示、解析推移は独自 SVG チャートで可視化。

## 🖥️ UI/UX

- ダーク固定・**青基調**（Pandaテーマ）
- ウルトラワイド対応（max-width ~2000px、横スクロール許容）
- フィルタバー（DatePicker / service / level / 全文検索）＋フル幅テーブル
- アクセシビリティ：フォント14–16px、行高1.4–1.6、フォーカスリング、キーボード操作

## 🚀 パフォーマンス方針（MVP→拡張）

- MVP：単日＋数十万行想定、**テーブル仮想化**で快適化
- 拡張：分割キーで並列取得 / サーバ側ページング / S3 Select対応（形式合致時）

## 🧼 PIIマスキング（現状オフ）

- 定義：個人識別情報を表示上で伏せる処理（例：`u***@d***`、`192.168.*.*`）
- 必要時に**トグル可能**な簡易マスキング関数を追加予定

---

## ✅ ローンチ・チェックリスト

- [ ]  Bun + Next.js v15 + Panda + Biome プロジェクト初期化
- [ ]  ダーク/青テーマのベーススタイル適用
- [ ]  `/api/logs`：S3 List/Get → JSON正規化 → 返却
- [ ]  DatePicker + フィルタバー（service/level/q）
- [ ]  TanStack Table（仮想化、動的列、JSONセル折りたたみ/コピー）
- [ ]  直近3日クイックアクション
- [ ]  エラーハンドリング（S3権限/ネットワーク/空データ）
- [ ]  （オプション）表示結果の**CSV/JSONエクスポート**

---

## 🗺️ スプリント（目安）

1. **環境初期化**：Bun/Next15/Panda/Biome、ダーク/青テーマ
2. **API**：S3 List/Get +（必要なら）解凍 + JSON正規化（単日）
3. **UI**：DatePicker/フィルタ/テーブル（仮想化＋動的列＋JSONセル）
4. **仕上げ**：直近3日ショートカット、空/エラーUI、ウルトラワイド最適化
5. **任意**：CSV/JSONエクスポート、簡易マスキングトグル

---

## ❓最終確認（明確化したい点）

1. `.enc` の**暗号方式**と鍵/IVの管理方法（KMS/パスフレーズ/鍵ファイル等）は？
2. **非JSONログ**（プレーン`.log`）が混ざる割合は？初期は**JSON行優先**抽出でよい？
3. **検索要件**：全文検索（message+JSON）で十分か、**正規表現検索**も初期から要る？
4. **エクスポート**（CSV/JSON）はMVPに含める？（表示中のフィルタ結果のみ出力）

---
