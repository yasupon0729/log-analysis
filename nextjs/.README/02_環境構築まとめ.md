# 環境構築まとめ - ログ解析アプリケーション

## 🎯 概要
S3から直接JSONログを取得し、テーブル表示するアプリケーションの環境構築手順です。
ダーク・青基調のUIで、認証・DB不要のシンプルな構成を採用します。

## 🧱 必要な技術スタック

### ランタイム・フレームワーク
- **Runtime**: Bun (最新版)
- **Framework**: Next.js v15 (App Router)
- **Language**: TypeScript

### UI・スタイリング
- **CSS**: Panda CSS (ダーク固定・青基調テーマ)
- **Table**: TanStack Table (仮想化対応)
- **Components**: 必要に応じて追加

### 開発ツール
- **Linter/Formatter**: Biome
- **Environment**: WSL (Windows Subsystem for Linux)

## 📝 前提条件

### システム要件
- WSL2がインストール済み（Windows環境の場合）
- Node.js 18.18以上（Bunが内部で使用）
- Git

### AWS関連
- AWS CLIがインストール済み（オプション）
- S3アクセス用のIAMユーザー作成済み
- 以下の権限を持つIAMポリシー設定済み：
  - `s3:ListBucket` (prefix: `logs/`)
  - `s3:GetObject` (`logs/`配下)

## 🚀 セットアップ手順

### 1. Bunのインストール

```bash
# WSL環境での実行を推奨
curl -fsSL https://bun.sh/install | bash

# インストール確認
bun --version
```

### 2. プロジェクトの作成

```bash
# プロジェクトディレクトリ作成
mkdir nextjs
cd nextjs

# Next.js 15プロジェクトの初期化
bunx create-next-app@latest .
# 設定プロンプトの推奨選択：
# ✔ Would you like to use ESLint? Biomeを選択
# ✔ Would you like to use Tailwind CSS? … No (Panda CSSを使用するため)

```


### 3. Biomeのセットアップ

```bash
# Biomeインストール
bun add -D @biomejs/biome

# Biome初期化
bunx biome init

# biome.jsonの設定
```

`biome.json`の基本設定(階層注意):
```json
{
  "$schema": "https://biomejs.dev/schemas/2.2.5/schema.json",
  "vcs": {
    "enabled": true,
    "clientKind": "git",
    "useIgnoreFile": true
  },
  "files": {
    "ignoreUnknown": true
  },
  "formatter": {
    "enabled": true,
    "indentStyle": "space"
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true,
      "style": {
        "noParameterAssign": "error",
        "useAsConstAssertion": "error",
        "useDefaultParameterLast": "error",
        "useEnumInitializers": "error",
        "useSelfClosingElements": "error",
        "useSingleVarDeclarator": "error",
        "noUnusedTemplateLiteral": "error",
        "useNumberNamespace": "error",
        "noInferrableTypes": "error",
        "noUselessElse": "error"
      },
      "performance": {
        "noImgElement": "off"
      }
    }
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "double"
    }
  }
}

```

### 4. Panda CSSのセットアップ(別ページ参照。log-analysis/.README.md/03_CSSの導入.md)

```bash
# Panda CSSインストール
bun add -D @pandacss/dev
bun add @pandacss/preset-panda

# Panda CSS初期化
bunx panda init --postcss

# panda.config.tsの設定（ダーク・青基調テーマ）
```

`panda.config.ts`の基本設定:
```typescript
import { defineConfig, defineGlobalStyles } from '@pandacss/dev'

export default defineConfig({
  preflight: true,
  include: ['./app/**/*.{ts,tsx,js,jsx}', './components/**/*.{ts,tsx,js,jsx}'],
  exclude: [],
  theme: {
    extend: {
      tokens: {
        colors: {
          primary: {
            50: { value: '#e6f2ff' },
            100: { value: '#bae3ff' },
            200: { value: '#7cc4fa' },
            300: { value: '#47a3f3' },
            400: { value: '#2186eb' },
            500: { value: '#0967d2' },
            600: { value: '#0552b5' },
            700: { value: '#03449e' },
            800: { value: '#01337d' },
            900: { value: '#002159' },
          },
          dark: {
            bg: { value: '#0f172a' },
            surface: { value: '#1e293b' },
            border: { value: '#334155' },
            text: { value: '#e2e8f0' },
            textMuted: { value: '#94a3b8' },
          }
        }
      },
      semanticTokens: {
        colors: {
          background: { value: { base: '{colors.dark.bg}' } },
          surface: { value: { base: '{colors.dark.surface}' } },
          border: { value: { base: '{colors.dark.border}' } },
          text: { value: { base: '{colors.dark.text}' } },
          textMuted: { value: { base: '{colors.dark.textMuted}' } },
        }
      }
    }
  },
  globalCss: defineGlobalStyles({
    body: {
      bg: 'background',
      color: 'text',
      fontFamily: 'system-ui, -apple-system, sans-serif',
    }
  }),
  outdir: 'styled-system',
})
```

### 5. Biomeのセットアップ (ワークスペースレベル)

**重要**: モノレポ構成でワークスペースレベルに配置します

```bash
# プロジェクトルートでBiomeインストール
cd /home/yasunari/KNiT/log-analysis
bun add -D @biomejs/biome

# Biome初期化 (ルートディレクトリで実行)
bunx biome init

# VSCode拡張機能のインストール
# VSCodeの拡張機能マーケットプレイスから「Biome」を検索してインストール
```

ワークスペースレベルの`package.json`作成:
```json
{
  "name": "log-analysis-workspace",
  "private": true,
  "workspaces": [
    "nextjs",
    "backend"
  ],
  "scripts": {
    "dev": "cd nextjs && bun dev",
    "build": "cd nextjs && bun build",
    "format": "bunx @biomejs/biome format --write .",
    "lint": "bunx @biomejs/biome check .",
    "lint:fix": "bunx @biomejs/biome check --write ."
  },
  "devDependencies": {
    "@biomejs/biome": "^1.9.4"
  }
}
```

`biome.json`の基本設定 (プロジェクトルート):
```json
{
  "$schema": "https://biomejs.dev/schemas/2.2.5/schema.json",
  "vcs": {
    "enabled": true,
    "clientKind": "git",
    "useIgnoreFile": true
  },
  "files": {
    "ignoreUnknown": true
  },
  "formatter": {
    "enabled": true,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineWidth": 100
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true,
      "style": {
        "noParameterAssign": "error",
        "useAsConstAssertion": "error",
        "useDefaultParameterLast": "error",
        "useEnumInitializers": "error",
        "useSelfClosingElements": "error",
        "useSingleVarDeclarator": "error",
        "noUnusedTemplateLiteral": "error",
        "useNumberNamespace": "error",
        "noInferrableTypes": "error",
        "noUselessElse": "error"
      }
    }
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "double"
    }
  },
  "organizeImports": {
    "enabled": true
  }
}
```

VSCode設定ファイル `.vscode/settings.json` (ワークスペースレベル):
```json
{
  "editor.defaultFormatter": "biomejs.biome",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "quickfix.biome": "explicit",
    "source.organizeImports.biome": "explicit"
  },
  "biome.enabled": true,
  "biome.configPath": "./biome.json",
  "[javascript]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[typescript]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[javascriptreact]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[json]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[jsonc]": {
    "editor.defaultFormatter": "biomejs.biome"
  },
  "[css]": {
    "editor.defaultFormatter": "biomejs.biome"
  }
}
```


その他
```bash
# nextjsディレクトリで実行
cd nextjs

# 日付処理
bun add date-fns

# エラーハンドリング
bun add zod

# 開発用ツール
bun add -D @types/node

# AWS SDK v3 
bun add @aws-sdk/client-s3

# TanStack Table v8
cd nextjs
bun add @tanstack/react-table @tanstack/react-virtual
```

###  環境変数の設定

`nextjs/.env.local`ファイルを作成:

```bash
# S3設定
S3_REGION=ap-northeast-1
S3_BUCKET=gexel-secure-storage
S3_PREFIX=logs/
AWS_ACCESS_KEY_ID=your_access_key_here
AWS_SECRET_ACCESS_KEY=your_secret_key_here

# アプリ設定
NEXT_PUBLIC_APP_NAME=Log Analysis Dashboard
NEXT_PUBLIC_MAX_LOGS_PER_REQUEST=10000

# MySQL(読み取り専用)設定
MYSQL_HOST=127.0.0.1
MYSQL_PORT=3306
MYSQL_USER=readonly_user
MYSQL_PASSWORD=your_password_here
MYSQL_DATABASE=log_analytics
MYSQL_POOL_SIZE=10        # 任意: プール接続数 (既定値: 10)
MYSQL_TIMEZONE=Asia/Tokyo # 任意: DBタイムゾーン (既定値: Z)
```

`MYSQL_POOL_SIZE` と `MYSQL_TIMEZONE` は省略可能です。読み取り専用ユーザーを必ず利用し、更新系権限を付与しないでください。


### 10. プロジェクト構造の準備

```bash
# nextjsディレクトリ内で実行
cd nextjs
mkdir -p app/api/logs
mkdir -p components/{ui,features,layouts}
mkdir -p lib/{aws,utils}
mkdir -p types
```

推奨ディレクトリ構造:
```
/home/yasunari/KNiT/log-analysis/
├── .vscode/
│   ├── settings.json    # ワークスペースVSCode設定
│   └── extensions.json  # 推奨拡張機能
├── biome.json          # ワークスペースレベルBiome設定
├── package.json        # ワークスペース管理
├── bun.lock
├── nextjs/
│   ├── app/
│   │   ├── api/
│   │   │   └── logs/
│   │   │       └── route.ts
│   │   ├── layout.tsx
│   │   ├── page.tsx
│   │   └── globals.css
│   ├── components/
│   │   ├── ui/
│   │   │   ├── Table.tsx
│   │   │   ├── DatePicker.tsx
│   │   │   └── FilterBar.tsx
│   │   ├── features/
│   │   │   └── LogViewer.tsx
│   │   └── layouts/
│   │       └── MainLayout.tsx
│   ├── lib/
│   │   ├── aws/
│   │   │   └── s3-client.ts
│   │   └── utils/
│   │       ├── log-parser.ts
│   │       └── data-normalizer.ts
│   ├── types/
│   │   └── log.ts
│   ├── styled-system/
│   ├── .env.local
│   ├── panda.config.ts
│   ├── package.json
│   └── tsconfig.json
└── backend/ (将来追加時)
    └── package.json
```

## 🧪 開発サーバーの起動

```bash
# ワークスペースルートから起動
cd /home/yasunari/KNiT/log-analysis
bun dev

# または nextjsディレクトリから直接起動
cd /home/yasunari/KNiT/log-analysis/nextjs
bunx panda --watch & bun dev

# ブラウザで確認
# http://localhost:3729
```

## 📦 本番ビルド

```bash
# ビルド
bun run build

# 本番サーバー起動
bun run start
```

## 🐳 Docker での配布・起動

```bash
# 初回ビルドと起動
docker compose up --build

# バックグラウンドで起動したい場合
docker compose up -d --build

# 停止
docker compose down
```

`.env.production` などの環境変数ファイルを `docker-compose.yml` の `env_file` に指定して認証情報を読み込みます。外部共有時は資格情報を含んだ env ファイルを配布しないよう注意してください。

## 🔧 package.jsonスクリプト設定

ワークスペースレベル (`/home/yasunari/KNiT/log-analysis/package.json`):
```json
{
  "scripts": {
    "dev": "cd nextjs && bun dev",
    "build": "cd nextjs && bun build",
    "format": "bunx @biomejs/biome format --write .",
    "lint": "bunx @biomejs/biome check .",
    "lint:fix": "bunx @biomejs/biome check --write ."
  }
}
```

Next.jsプロジェクト (`nextjs/package.json`):
```json
{
  "scripts": {
    "dev": "bunx panda --watch & next dev --port 3729",
    "build": "bunx panda && next build",
    "start": "next start --port 3729",
    "type-check": "tsc --noEmit"
  }
}
```

## ⚠️ 注意事項

### セキュリティ
- AWS認証情報は必ず環境変数で管理
- `.env.local`は絶対にGitにコミットしない
- S3アクセスは必ずサーバーサイド（API Route）経由で実行

### パフォーマンス
- 大量データ表示時はTanStack Tableの仮想化を活用
- S3からの取得は必要最小限に制限（日付指定など）

### 開発環境
- WSL環境推奨（Windows環境の場合）
- Bunの高速性を活かすため、npm/yarnは使用しない
- **重要**: VSCodeは必ずワークスペースルート `/home/yasunari/KNiT/log-analysis` から開く

## 🚨 トラブルシューティング

### Ctrl+S自動フォーマットが効かない場合
1. VSCodeをワークスペースルートから開き直す
   ```bash
   cd /home/yasunari/KNiT/log-analysis
   code .
   ```
2. Biome拡張機能がインストールされているか確認
3. コマンドパレット (Ctrl+Shift+P) で「Format Document With...」→「Biome」を選択
4. VSCodeを再起動

### Bunインストール失敗時
```bash
# 手動インストール
curl -fsSL https://bun.sh/install | bash -s "bun-v1.0.0"
```

### Panda CSSビルドエラー時
```bash
# nextjsディレクトリで実行
cd nextjs
rm -rf styled-system
bunx panda codegen
```

### S3接続エラー時
- AWS認証情報の確認
- IAMポリシーの権限確認
- リージョン設定の確認

## 📚 参考リンク
- [Bun Documentation](https://bun.sh/docs)
- [Next.js 15 Documentation](https://nextjs.org/docs)
- [Panda CSS Documentation](https://panda-css.com/docs)
- [TanStack Table Documentation](https://tanstack.com/table/latest)
- [Biome Documentation](https://biomejs.dev/)
