# ロギングとシステムログ機能

このプロジェクトでは、アプリケーションの動作状況を把握するために、バックエンド（サーバー）とフロントエンド（クライアント）の両方で統一されたロギング機構を導入しています。また、それらのログをブラウザ上で確認できるシステムログ閲覧機能を提供しています。

## 1. ログアーキテクチャ概要

ロギングライブラリとして **Pino** を使用し、パフォーマンスと構造化ログ（JSON形式）を両立させています。

### 構成要素
*   **Logger Wrapper (`src/lib/logger`)**: Pino のラッパー。環境（Server/Client）に応じた適切な設定と、共通のメタデータ（環境名、ソースなど）の付与を行います。
*   **Server Logger**: Node.js 環境で動作。ファイルシステムと標準出力（本番環境）にログを出力します。
*   **Client Logger**: ブラウザ環境で動作。コンソール出力に加え、`/api/logs` エンドポイント経由でサーバーにログを送信します。
*   **API Endpoint (`/api/logs`)**: クライアントから送信されたログを受け取り、サーバー側のログとして保存・出力します。
*   **System Logs Viewer (`/system-logs`)**: 蓄積されたログファイルを読み込み、UI上で表示する管理機能です。

## 2. ログ出力仕様

### 出力先
ログは環境 (`NODE_ENV`) によって出力先が異なります。

| 環境 | 出力先 (Server) | 出力先 (Client -> Server) | 備考 |
| :--- | :--- | :--- | :--- |
| **Development** | `logs/server/app-dev.log`<br>Console (Pretty Print) | `logs/client/app-dev.log`<br>Console | 開発時はファイルとコンソールの両方に見やすく出力 |
| **Production** | `logs/server/app-prod.log`<br>**stdout (JSON)** | `logs/client/app-prod.log`<br>**stdout (JSON)** | **Docker環境対応:** `docker compose logs` で確認可能 |

### ログレベル
*   `fatal`: システム停止級のエラー
*   `error`: エラー、例外発生
*   `warn`: 警告（非推奨APIの使用など）
*   `info`: 通常の操作ログ（ページ遷移、APIコールなど）
*   `debug`: デバッグ情報（開発環境のみデフォルト有効）
*   `trace`: 詳細なトレース情報

## 3. システムログ閲覧機能 (`/system-logs`)

アプリケーションの稼働ログをブラウザからリアルタイムに近い形で確認できます。

### 機能
*   **ソース切り替え**: "Server" (バックエンド) と "Client" (フロントエンド) のログを切り替えて表示。
*   **自動更新**: 5秒ごとに最新のログを取得（ON/OFF可能）。
*   **詳細表示**: 各ログ行の "JSON" をクリックすると、生のJSONデータを確認可能。
*   **レベル別色分け**: ERRORは赤、WARNは黄色などで視覚的に識別。

### アクセス方法
サイドバーの「システムログ (💻)」メニューからアクセスします。

## 4. 開発者向けガイド

### ログの出力方法

```typescript
import { logger } from "@/lib/logger"; // 自動的に server/client を判別

// 通常のメッセージ
logger.info("ユーザーがログインしました", { userId: "123" });

// エラーログ
try {
  // ...
} catch (error) {
  logger.error("データ取得に失敗しました", { error, query: "..." });
}
```

### コマンドラインでのログ確認 (Docker環境)

```bash
# 全コンテナのログを流す
make logs

# ログをファイルにエクスポート (直近1時間)
make output-log

# 時間を指定してエクスポート (例: 24時間)
make output-log 24
```

## 5. 実装詳細メモ

*   **stdoutへの出力**: Dockerコンテナ環境では、ファイルへの出力に加えて標準出力 (stdout) にJSON形式でログを流すことが推奨されます（The Twelve-Factor App）。これにより、DatadogやCloudWatchなどのログ収集基盤との連携が容易になります。
*   **クライアントログの送信**: ブラウザの `beforeunload` イベントなどを利用して、ページ遷移直前のログも極力送信するように実装されていますが、ネットワーク状況によっては欠損する可能性があります。
*   **ログローテーション**: 現在の実装では簡易的なファイル出力を行っています。長期運用時は `pino-roll` などの導入や、外部ログ基盤への転送を検討してください。
