# プレビュー機能の現状整理

## フロー全体の概要
- `/results` テーブルで行選択または詳細モーダルを開くと、`src/app/results/page-client.tsx` 内の `loadPreviewPairs` が起動する。
- プレビュー対象の解析 ID とユーザー ID を `deriveAnalysisIdentifiersFromDownloadLink` (`src/lib/analysis-results/download-link.ts`) で解決し、見つからなければ行データの `imageAnalysisId`/`analysisDataId` を利用する。
- まず `/api/analysis-results` に対して `limit=500` で直接 S3 一覧を取得し、`origin.png` と `segmentation.png` の組み合わせを組み立てる。
- 直接取得でペアが見つからなければ `/api/analysis-results/fallback` を呼び出し、ZIP から画像を抽出したフォールバック結果を利用する。

## 1. 解析 ID・プレフィックスの解決
- ダウンロードリンクは `product/user/{userId}/analysis_result/main/{analysisId}/...` の形式を想定している。
- 現状は `main` セグメントのみを正規表現で認識し、`recommend` や `screening` には未対応。
- 解決できなかった場合は UI 上でエラーを出し、フォールバック処理へ移らない。

## 2. S3 からのプレビュー用データ取得
- `GET /api/analysis-results` (`src/app/api/analysis-results/route.ts`) は対象ユーザー配下の S3 オブジェクトをキャッシュ付きで走査し、`AnalysisResultFileEntry` の配列を返す。
- クライアント側では `buildPreviewPairsFromFiles` が解析 ID ごとにディレクトリ単位でファイルをグルーピングし、`origin.png` と `segmentation.png` のペアのみを抽出・ソートする。
- 抽出に成功するとモーダルではサムネイル一覧を、ローンチ前画面ではヒントメッセージと件数を表示する。

## 3. フォールバック処理
- ペアが見つからない場合は `POST /api/analysis-results/fallback` (`src/app/api/analysis-results/fallback/route.ts`) を呼び出す。
- S3 から ZIP をダウンロードし、`JSZip` で解析して `統計` シートを優先しつつ埋め込み画像を抽出し、Base64 Data URL として返却する。
- フォールバック結果は `AnalysisImagePair` の `originInline`/`segmentationInline` に展開され、そのまま `<img>` にバインドされる。

## 4. キャッシュと UI 表示制御
- リクエスト単位のキャッシュキーを `previewCacheKeyRef` で管理し、同一解析を連続で開いた際の再取得を避ける。
- `cache: "no-store"` で都度取得する方針だが、S3 API 側ではサーバー内キャッシュ (`analysisCache`) が 15 分 (+環境変数で調整可能) で保持される。
- UI ではローディングスピナー、`AlertBanner` ベースのエラー表示、フォールバック結果のメタ表示を共通化している。

## 5. 現状の制約・課題
- ダウンロードリンクから解析 ID を解決できるのは本解析 (`main`) のみで、新版スクリーング (`recommend`) や旧版スクリーング (`screening`) のパス構造は未対応。
- 直接取得は `origin.png`/`segmentation.png` の固定ファイル名に依存しており、`original_images` 配下や ZIP 内の個別 PNG/JPG にはアクセスしていない。
- フォールバックは ZIP 内の Excel ブックに依存するため、ZIP に PNG ファイルが直置きされているケースには対応していない。

## 6. 新版/旧版スクリーング対応に向けたメモ
- 新版: `product/user/{id}/analysis_result/recommend/{analysisId}/original_images/` の配下を優先列挙し、続けて `recommend/{analysisId}/` 直下の PNG を表示する必要がある。
- 旧版: `original_images` があれば表示し、なければ ZIP (`*_res.zip`) を展開して PNG/JPG をプレビューに利用する必要がある。
- 上記を実現するにはダウンロードリンク解析、S3 走査ロジック、プレビュー UI の拡張が必要になる。
