# エラーハンドリング方針

## サーバーサイド
- 例外は原則 `ValidationError` / `ForbiddenError` / `DependencyError` / `UnexpectedError` に分類し、HTTP ステータスと `code` を合わせて返す。
- API レスポンスは `{ ok: false, code, message, details }` 形式に統一する。
  - `details` にはフィールド単位のエラー情報を格納し、クライアント側でフォームに反映させる。
- Pino ログは `errorCode`, `requestId`, `userId` などのコンテキストを付与し、`logger.error` で構造化出力する。
- Server Actions / API Routes からは上記例外を投げ、呼び出し側で `Result` 型ないし `try/catch` で扱う。

## クライアントサイド
- 画面全体やフォーム共通のエラー表示は `AlertBanner` コンポーネント（`@/components/ui/AlertBanner`）を利用する。
  - `variant="error"` / `info` / `warning` / `success` を切り替え、タイトルとメッセージは日本語で表示。
  - 詳細な英語メッセージやデバッグ情報はログに留め、UI ではユーザーが理解しやすい文言にする。
- フォームはクライアント側で即時バリデーションしつつ、サーバー側の `details` を受けてフィールドへメッセージを再表示する。
- モーダルやテーブルなど部分的な UI も `AlertBanner` を用いて統一したスタイルで通知する。

## ロギング & トレース
- レスポンスヘッダーまたはボディに `requestId` を含め、トレースしやすくする。
- 重大なエラーは `logger.error`、ユーザー操作由来のバリデーション失敗は `logger.info` / `warn` で分ける。

## 実装状況
- `/results` ページと EC2 セキュリティグループ詳細、アップロード画面は `AlertBanner` を導入済み。
- 他の画面でもエラー表示を追加する際は本方針に従う。
