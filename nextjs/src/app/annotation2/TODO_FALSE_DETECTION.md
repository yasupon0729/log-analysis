# 誤認識除去機能 実装タスクリスト

このドキュメントは、アノテーションツールの「誤認識除去」機能を実装するための詳細なステップを記述します。

## フェーズ 1: 基盤構築とデータの表示 (データの可視化)

1.  **型定義の作成 (`_types/index.ts`)**
    *   [x] `AnnotationRegion`, `Point` インターフェースの定義。
    *   [x] COCOフォーマット (`CocoData`, `CocoAnnotation`) の型定義。
    *   [x] メトリクス情報 (`MetricStat`) の型定義。

2.  **データローダーの実装 (`_lib/data-loader.ts`) - Part 1 (JSON)**
    *   [x] `input/segmentation.json` を読み込む関数の作成。
    *   [x] COCOフォーマットの `seg` (ポリゴン) データを `Point[]` に変換するロジックの実装。

3.  **データローダーの実装 (`_lib/data-loader.ts`) - Part 2 (CSV)**
    *   [x] `input/result.csv` を読み込み、各列をパースする処理の実装。
    *   [x] JSONのIDとCSVのIDを紐付け、`AnnotationRegion` に `metrics` として結合する処理の実装。
    *   [x] 各メトリクスの最小値・最大値を計算し、`stats` として返す処理の実装。

4.  **サーバーコンポーネントの実装 (`page.tsx`)**
    *   [x] `data-loader` を呼び出し、データを取得する。
    *   [x] `input/origin.png` をキャッシュ付きエンドポイント (`/annotation2/image`) 経由で配信し、クライアントにURLを渡す。
    *   [x] クライアントコンポーネント (`AnnotationPageClient`) へデータを渡す。

5.  **描画コンポーネントの実装 (`_components/CanvasLayer.tsx`) - Part 1 (画像)**
    *   [x] HTML5 Canvas 要素の配置。
    *   [x] 画像URL（Data URL含む）を Canvas に描画する処理の実装。
    *   [x] ウィンドウリサイズ等への対応（今回は固定サイズか、親要素に合わせるか要検討）。

6.  **描画コンポーネントの実装 (`_components/CanvasLayer.tsx`) - Part 2 (アノテーション)**
    *   [x] `AnnotationRegion` 配列を受け取り、ポリゴンを描画する処理の実装。
    *   [x] デフォルトのスタイル（塗りつぶし色、枠線色）の適用。

## フェーズ 2: インタラクションと個別削除 (クリックで消す)

7.  **状態管理の実装 (`_components/AnnotationPageClient.tsx`)**
    *   [x] `removedIds` (Set) ステートの定義。
    *   [x] `hoveredId` (number | null) ステートの定義。
    *   [x] 領域クリック時のハンドラ関数の作成（`removedIds` への追加/削除トグル）。

8.  **ホバー判定ロジックの実装 (`_components/CanvasLayer.tsx`)**
    *   [x] マウス移動イベント (`onMouseMove`) のハンドリング。
    *   [x] 座標変換（画面座標 -> Canvas内部座標）。
    *   [x] 点と多角形の当たり判定 (Point-in-Polygon) アルゴリズムの実装。
    *   [x] ホバー状態の領域IDを親コンポーネントに通知する処理。

9.  **状態に応じた再描画 (`_components/CanvasLayer.tsx`)**
    *   [x] `removedIds` に含まれる領域を描画しない（または「削除済み」として赤く表示する）ロジックの追加。
    *   [x] `hoveredId` に一致する領域をハイライト表示するロジックの追加。

## フェーズ 3: 誤認識再登録機能の検証 (クリックで元に戻す)

10. **クリックによる状態トグルの検証**
    *   [x] 削除済みとして赤く表示されている領域を再クリックした際に、通常のアノテーション表示に戻る（`removedIds` から削除される）ことを確認する。
    *   [x] 削除済み状態から元に戻ったアノテーションが、フィルタリングの対象外であれば、そのメトリクスに基づいてフィルタリングが適用されることを確認する。

11. **保存機能との連携検証**
    *   [x] 削除済みリストから復元したアノテーションが、保存ボタン押下時に `remove.json` からも正しく削除されることを確認する。
    *   [x] ページ再読み込み後、`remove.json` の変更が反映され、復元したアノテーションが再度削除済みとしてロードされないことを確認する。

## フェーズ 4: フィルタリングによる一括除去 (閾値で消す)

12. **フィルタリングUIの作成 (`_components/ControlPanel.tsx`)**
    *   [x] `MetricStat` を受け取り、メトリクスごとのスライダー（または数値入力）リストを表示するコンポーネントの実装。
    *   [x] 各スライダーの変更イベントを親コンポーネントに通知する仕組みの実装。

13. **フィルタリングロジックの統合 (`_components/AnnotationPageClient.tsx`)**
    *   [x] `filters` ステートの実装（各メトリクスの [min, max] 範囲）。
    *   [x] 現在の `filters` 設定に基づいて、表示すべきIDリスト (`filteredIds`) を計算する `useMemo` フックの実装。
    *   [x] `CanvasLayer` に `filteredIds` を渡し、除外された領域を薄く表示（または非表示）にする処理の連携。

## フェーズ 5: 検証とデバッグ

14. **ビルド検証**
    *   [x] `bun run build` を実行し、ビルドが成功することを確認する。
    *   [x] ビルドエラー (`PageNotFoundError`) の原因を特定し、修正する。

15. **実行時検証**
    *   [x] `bun dev` で開発サーバーを起動し、ページが正しく表示されることを確認する。
    *   [x] 画像とアノテーションが正しく描画されていることを確認する。
    *   [x] マウスホバーでアノテーションがハイライトされることを確認する。
    *   [x] クリックでアノテーションが削除/復元されることを確認する。
    *   [x] フィルタリングUIでメトリクスを操作し、Canvas上のアノテーションが正しくフィルタリングされることを確認する。

16. **UI調整とクリーンアップ**
    *   [ ] 全体のレイアウト調整（Panda CSS使用）。
    *   [ ] `CanvasLayer` の `width`/`height` をハードコードから動的に取得するように修正（COCOデータまたは親要素のサイズから）。
    *   [ ] コードの整理（不要なログの削除、コメントの追加、型アサーションの最適化）。
    *   [ ] 既存の `src/app/annotation` ページのコードを参考に、`token.ts` のようなグローバル定数ファイルの必要性を検討。

## フェーズ 6: 範囲選択による一括除去機能（クリック/ドラッグ両立）

17. **インタラクションの統合 (`CanvasLayer.tsx`)**
    *   [ ] `selectionMode` プロパティを削除（外部からの制御を廃止）。
    *   [ ] `onMouseDown` で開始座標を記録。
    *   [ ] `onMouseMove` で、開始座標から一定距離（例: 5px）以上移動した場合のみ `isDragging` を有効化し、矩形を描画するロジックに変更。
    *   [ ] `onMouseUp` で条件分岐:
        *   `isDragging` が `true` の場合: 範囲選択ロジック（矩形内のアノテーション特定と一括操作）を実行。
        *   `isDragging` が `false` の場合: クリックロジック（単一アノテーションのトグル）を実行。

18. **クライアントコンポーネントのクリーンアップ (`AnnotationPageClient.tsx`)**
    *   [ ] `selectionMode` ステートとモード切り替えボタンを削除。
    *   [ ] シンプルになった `CanvasLayer` インターフェースに合わせて Props を修正。

19. **検証**
    *   [ ] クリックで単一アノテーションが削除/復元できることを確認。
    *   [ ] ドラッグで矩形が表示され、範囲内のアノテーションが一括で削除/復元されることを確認。
    *   [ ] わずかなマウスの動き（手ブレ）では範囲選択にならず、クリックとして機能することを確認。

## フェーズ 7: 画像のズーム機能（マウスホイール操作）

20. **ズーム/パン状態管理の実装 (`CanvasLayer.tsx`)**
    *   [ ] `transform` state (`{ scale: number, x: number, y: number }`) を追加。
    *   [ ] `onWheel` イベントハンドラを実装し、マウス位置を中心としたズーム計算を行う。

21. **描画ロジックの更新 (`CanvasLayer.tsx`)**
    *   [ ] `draw` 関数内で `ctx.setTransform` を使用し、ズームと移動を適用してから画像とアノテーションを描画する。

22. **座標変換ロジックの更新 (`CanvasLayer.tsx`)**
    *   [ ] `getCanvasCoordinates` 関数を修正し、画面上のマウス座標から、ズーム/移動を考慮した元の画像座標系への逆変換を実装する。
    *   [ ] これにより、ズーム状態でもホバー判定やクリック判定、範囲選択が正しく動作することを確認する。

23. **検証**
    *   [ ] マウスホイールでスムーズに拡大縮小できることを確認。
    *   [ ] 拡大状態でクリックや範囲選択を行い、正しい位置（アノテーション）が反応することを確認。

## フェーズ 8: パフォーマンス最適化

24. **画像配信APIの実装**
    *   [ ] `src/app/api/annotation2/image/route.ts` を作成し、画像をストリーム配信する。

25. **クライアント側の読み込み変更**
    *   [ ] `src/app/annotation2/page.tsx` でのBase64変換を削除。
    *   [x] `src/app/annotation2/_components/AnnotationPageClient.tsx` のPropsを `imageBase64` から `imageUrl` に変更。

