# Rule Editor (Pipeline) の使い方と詳細仕様

Rule Editor は、設定した条件（フィルタ）に基づいて、アノテーション領域のクラス（カテゴリ）を**自動的に分類・変更**するための機能です。
複数のルールを作成し、それらを順次適用することで、複雑な分類ロジック（パイプライン）を構築できます。

---

## チュートリアル: 面積が2000以上のものを "Remove" する

「面積 (Area) が 2000 以上の領域」を自動的に「Remove (Trash)」クラスに分類する手順を説明します。

### 手順

1.  **ターゲットクラス（Action）の設定**
    *   右サイドバーの **Rule Editor** セクションを見ます。
    *   **To Class (Action)** のプルダウンから、**`Remove (Trash)`** を選択します。
        *   *（もし存在しない場合は `+ New Class` で作成してください）*
    *   **From Class** は **`Any Class`** のままで構いません（すべての領域を対象にする場合）。

2.  **条件（Filter）の作成**
    *   Rule Editor 内の **Condition (Filter)** エリア（Control Panel）を操作します。
    *   **Root Group の設定（重要）**:
        *   **Action**: **必ず `KEEP` に設定してください。**
        *   *※ここで `REMOVE` を選択すると、条件が反転して「条件に合わないもの」が対象になってしまう場合があります。*
    *   **`+ Condition`** ボタンをクリックして、条件を追加します。
    *   追加された条件パネルで以下を設定します：
        *   **Metric**: ドロップダウンから **`Area`** を選択。
        *   **Min**: **`2000`** と入力。
        *   **Max**: データの最大値（スライダーの右端、または十分大きな数値）を入力。
    *   *確認: 論理式表示エリアに `KEEP Area[2000 <= x <= ...]` のように表示されていることを確認します。*

3.  **パイプラインへの追加**
    *   設定が完了したら、下部の **`+ Add to Pipeline`** ボタンをクリックします。
    *   ダイアログが表示されるので、ルール名を入力します（例: `Remove Large Areas`）。
    *   **Execution Pipeline** リストに新しいルールが追加され、キャンバス上の該当する領域の色が即座に「Remove (Trash)」の色（赤色）に変わります。

4.  **保存**
    *   結果に問題がなければ、最下部の **`Save All Changes`** ボタンを押して、ルールと分類結果を保存します。

---

## 内部の挙動 (Internal Behavior)

システム内部でこのルールがどのように処理されているかを解説します。

### 1. フィルタ評価ロジック (`evaluateFilter`)
パイプラインでもキャンバス表示と同じ **Keep/Remove の意味** で判定する。

*   `evaluateFilter(...) === false` になった領域（= フィルタで弾かれる側）がルールの適用対象になる。
    *   Root Action が `KEEP` の場合: スライダー範囲 **外** が対象。
    *   Root Action が `REMOVE` の場合: スライダー範囲 **内** が対象。
*   `fromClass` が指定されていれば、上記対象のうち現在のクラスが一致するものだけを変換する。

### 2. 実行フロー (Execution Pipeline)
ルールが追加・変更されると、以下のプロセスがリアルタイムで実行されます（`recalculateClassifications`）。

1.  **初期化**: すべての領域のクラスを「未分類（またはデフォルト）」の状態から計算を開始します。
2.  **順次適用 (Sequential Execution)**:
    *   リストの上にあるルールから順に適用されます。
    *   **Rule A**: 「面積 >= 2000」の領域を探し、見つかった領域のクラスを一時的に `Remove` に書き換えます。
    *   **Rule B**: （もしあれば）次のルールが、Rule Aの結果に対してさらに適用されます。
        *   *例: 「円形度が高い」ものを `Class 2` にするルールが後にあれば、一度 `Remove` になったものでも、条件に合えば `Class 2` に上書きされます。*
3.  **最終結果の確定**:
    *   すべてのルール適用後の結果が `pipelineResults` (メモリ上の状態) として保持されます。

### 3. データ優先順位 (Data Precedence)
画面上の最終的な表示クラス (`mergedClassifications`) は、以下の優先順位で決定されます。

1.  **Manual Overrides (手動設定)**: **[最優先]**
    *   ユーザーがキャンバス上で直接クリック、または範囲選択してクラスを指定したもの。
    *   これらは `manual_classifications.json` に保存され、パイプラインのルールが変わっても維持されます。
2.  **Pipeline Results (自動分類)**:
    *   手動設定がない領域に対して、パイプラインの計算結果が適用されます。
3.  **Original / Default**:
    *   ルールにも手動設定にも該当しない場合、元のカテゴリまたはデフォルトクラスが表示されます。

---

## トラブルシューティング

### Q. 設定とは逆に「2000未満」が赤くなってしまう（逆転現象）
**原因の可能性**:
Root Action が意図と逆になっており、パイプラインの適用対象（`evaluateFilter === false` 側）がずれている。

**対処法**:
1.  Root を `KEEP` にすると「範囲外」が To Class の対象、`REMOVE` にすると「範囲内」が対象になる。ハイライトされている領域が意図した側か確認する。
2.  意図した側がハイライトされる設定に直してから `+ Add to Pipeline` をやり直す。
